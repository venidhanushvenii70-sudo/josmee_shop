{% extends 'base.html' %}

{% block title %}Checkout - Josmee{% endblock %}

{% block content %}
<style>
    /* Custom Styling for Josmee Checkout */
    :root {
        --josmee-primary: #007bff; /* Primary color for buttons/links */
        --josmee-card-bg: #ffffff;
        --josmee-border-color: #e9ecef;
        --josmee-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
    }
    .checkout-title {
        text-align: center; /* Centering the main title */
        font-size: 32px;
        font-weight: 700;
        color: #343a40;
        margin-bottom: 40px;
    }
    .card-custom {
        border: 1px solid var(--josmee-border-color);
        border-radius: 12px;
        box-shadow: var(--josmee-shadow);
    }
    /* Updated radio-card for cleaner payment/address list style */
    .radio-card {
        transition: all 0.2s;
        cursor: pointer;
        padding: 1rem 1.25rem;
        border: 1px solid var(--josmee-border-color);
        border-radius: 8px;
        display: flex;
        align-items: flex-start; /* Align content to start for radio button */
        flex-direction: column; /* Allow content to stack */
        position: relative; /* Needed for positioning action buttons */
    }
    .radio-card-header {
        width: 100%;
        display: flex;
        align-items: center;
    }
    .radio-card-body {
        width: 100%;
        display: flex;
        align-items: flex-start;
        padding-top: 0.5rem;
    }
    .radio-card-label {
        flex-grow: 1;
        padding-left: 0.5rem; /* Space between radio and text */
    }
    .radio-card:hover {
        background-color: #f8f9fa;
    }
    .radio-card input {
        border: 1px solid #ccc;
        margin-top: 0.2rem !important;
        flex-shrink: 0; /* Keep radio button from stretching */
    }
    .radio-card input:checked {
        border-color: var(--josmee-primary) !important;
        background-color: var(--josmee-primary) !important;
    }
    .payment-details-content {
        /* Initially hidden content that will be toggled by JS */
        display: none;
        width: 100%;
        padding-top: 15px;
        margin-top: 15px;
        border-top: 1px solid #eee;
    }
    .sticky-summary {
        top: 30px;
    }
    
    /* NEW: Address Action Buttons Styling */
    .address-actions {
        position: absolute;
        top: 1rem;
        right: 1.25rem;
        z-index: 10; /* Ensure buttons are clickable */
    }
    .address-actions a {
        font-size: 0.8rem;
        margin-left: 0.5rem;
        text-decoration: none;
    }
    .address-radio-card {
        padding-right: 100px; /* Make space for action buttons */
    }
</style>

<div style="max-width: 1200px; margin:0 auto; padding:32px 16px;">

    <h2 class="checkout-title">
        <i class="fas fa-lock me-2"></i> Secure Checkout
    </h2>

    <form method="POST">
        {% csrf_token %}
        <div class="row g-4"> 
            
            <div class="col-md-8">

                <div class="card card-custom mb-4">
                    <div class="card-body p-4">
                        <h4 class="fw-bold mb-4">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i> 1. Select Delivery Address
                        </h4>

                        {% if addresses %}
                            {% for address in addresses %}
                            <div class="radio-card mb-3 address-radio-card">
                                
                                <div class="radio-card-header">
                                    <input class="form-check-input" type="radio" name="address"
                                           value="{{ address.id }}" id="addr{{ address.id }}"
                                           {% if address.is_default %}checked{% endif %} style="margin-top: 0.5rem;">
                                    
                                    <label for="addr{{ address.id }}" class="form-check-label radio-card-label">
                                        <span class="d-block">
                                            <strong>{{ address.full_name }}</strong> {% if address.is_default %}<span class="badge bg-secondary ms-2">Default</span>{% endif %}
                                        </span>
                                        <span class="d-block text-secondary small mt-1">
                                            {{ address.address_line1 }}{% if address.address_line2 %}, {{ address.address_line2 }}{% endif %},
                                            {{ address.city }}, {{ address.state }} - **{{ address.pincode }}**
                                        </span>
                                        <span class="d-block text-secondary small mt-1">
                                            Phone: {{ address.phone }}
                                        </span>
                                    </label>

                                </div>
                                
                                <div class="address-actions">
                                    <a href="{% url 'accounts:edit_address_page' address.id %}" class="text-primary fw-bold">
                                        <i class="fas fa-edit me-1"></i> Edit
                                    </a>
                                    <a href="{% url 'accounts:delete_address' address.id %}" class="text-danger fw-bold" 
                                       onclick="return confirm('Are you sure you want to delete this address?');">
                                        <i class="fas fa-trash-alt me-1"></i> Delete
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                No saved addresses found. Please add a new address to continue.
                            </div>
                        {% endif %}

                        <a href="{% url 'accounts:add_address_page' %}" 
                           class="btn btn-outline-primary mt-3" style="border-radius:8px;">
                           <i class="fas fa-plus"></i> Add New Address
                        </a>
                    </div>
                </div>

                <div class="card card-custom mb-4">
                    <div class="card-body p-4">
                        <h4 class="fw-bold mb-4">
                            <i class="fas fa-wallet me-2 text-primary"></i> 2. Select Payment Method
                        </h4>
                        
                        <div class="radio-card mb-3">
                            <div class="radio-card-header w-100">
                                <input class="form-check-input me-3 payment-radio" type="radio" name="payment_method" value="cod" id="cod" checked data-target="cod-details" style="margin-top: 0.2rem;">
                                <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="cod">
                                    <span class="payment-title">
                                        <i class="fas fa-truck-loading me-2 text-success"></i> 
                                        <strong>Cash on Delivery (COD)</strong>
                                    </span>
                                    <span class="badge bg-success">Selected</span>
                                </label>
                            </div>
                        </div>

                        <div class="radio-card mb-3">
                            <div class="radio-card-header w-100">
                                <input class="form-check-input me-3 payment-radio" type="radio" name="payment_method" value="razorpay" id="razorpay" data-target="razorpay-details" style="margin-top: 0.2rem;">
                                <label class="form-check-label w-100" for="razorpay">
                                    <span class="payment-title d-block">
                                        <i class="fas fa-credit-card me-2"></i> 
                                        <strong>Credit/Debit Card, Netbanking</strong>
                                    </span>
                                    <small class="text-muted d-block ms-4">Pay securely with Razorpay.</small>
                                </label>
                            </div>
                            <div id="razorpay-details" class="payment-details-content">
                                <p class="text-secondary small mb-2">You will be redirected to the secure Razorpay payment gateway after placing the order.</p>
                                <div class="alert alert-info py-2">
                                    <i class="fas fa-info-circle me-1"></i> Transaction Limit: ₹2,00,000
                                </div>
                            </div>
                        </div>

                        <div class="radio-card mb-3">
                            <div class="radio-card-header w-100">
                                <input class="form-check-input me-3 payment-radio" type="radio" name="payment_method" value="upi" id="upi" data-target="upi-details" style="margin-top: 0.2rem;">
                                <label class="form-check-label w-100" for="upi">
                                    <span class="payment-title d-block">
                                        <i class="fas fa-mobile-alt me-2"></i> 
                                        <strong>UPI Payment (Google Pay, PhonePe, etc.)</strong>
                                    </span>
                                    <small class="text-muted d-block ms-4">Quick and seamless UPI payments.</small>
                                </label>
                            </div>
                            <div id="upi-details" class="payment-details-content">
                                <input type="text" class="form-control form-control-sm mb-2" placeholder="Enter your VPA (e.g., username@bankname)">
                                <button type="button" class="btn btn-sm btn-outline-success">Verify UPI ID</button>
                            </div>
                        </div>

                        <div class="radio-card mb-0 text-muted">
                            <div class="radio-card-header w-100">
                                <input class="form-check-input me-3" type="radio" name="payment_method" value="wallet" id="wallet" disabled style="margin-top: 0.2rem;">
                                <label class="form-check-label w-100" for="wallet">
                                    <span class="payment-title d-block">
                                        <i class="fas fa-wallet me-2"></i> 
                                        <strong>Wallets (Unavailable)</strong>
                                    </span>
                                </label>
                            </div>
                        </div>
                        
                    </div>
                </div>

            </div>

            <div class="col-md-4">
                <div class="card card-custom sticky-top sticky-summary">
                    <div class="card-body p-4">

                        <h4 class="fw-bold mb-4">Order Summary</h4>

                        {% for item in cart_items %}
                        <div class="d-flex justify-content-between mb-2 small text-muted">
                            <span class="text-truncate me-2">{{ item.product.name|default:"Product Name" }} x {{ item.quantity|default:"1" }}</span>
                            <span class="fw-bold">₹{{ item.total_price|default:"0.00" }}</span>
                        </div>
                        {% endfor %}

                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-dark">Subtotal:</span>
                            <span class="fw-bold">₹{{ total|default:"0.00" }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-dark">Delivery Charges:</span>
                            <span class="text-success fw-bold">FREE</span>
                        </div>
                        <hr>

                        <div class="d-flex justify-content-between mb-4 fw-bold" style="font-size:22px;">
                            <span>Total Payable:</span>
                            <span class="text-primary">₹{{ total|default:"0.00" }}</span>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-lg" style="border-radius:8px;">
                            <i class="fas fa-shopping-bag me-2"></i> Confirm & Place Order
                        </button>

                    </div>
                </div>
            </div>

        </div>
    </form>

</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Payment method interaction logic (Unchanged, copied from previous response)

    // 1. Show the content corresponding to the initially checked radio button (COD)
    var initialTargetId = $('.payment-radio:checked').data('target');
    if (initialTargetId) {
        $('#' + initialTargetId).slideDown(200);
    }

    // 2. Handle radio button changes
    $('.payment-radio').on('change', function() {
        // Hide all details first
        $('.payment-details-content').slideUp(200);

        // Get the target ID from the data-target attribute
        var targetId = $(this).data('target');
        
        // Show the corresponding details section (if it exists)
        if (targetId) {
            $('#' + targetId).slideDown(200);
        }
    });

    // Optional: Enhance the visual active state on the radio-card div when checked
    $('.radio-card').has('.payment-radio').on('click', function(e) {
        // Check if the click was on an action button (Edit/Delete)
        if ($(e.target).closest('.address-actions').length) {
            return; // Do nothing if an action button was clicked
        }
        
        // Find the radio button inside this card and check it
        var $radio = $(this).find('.payment-radio');
        if (!$radio.prop('checked')) {
            $radio.prop('checked', true).trigger('change');
        }
    });

    // Address radio card click handler (to select the address)
    $('.address-radio-card').on('click', function(e) {
        // Prevent selecting the address if clicking the action buttons
        if ($(e.target).closest('.address-actions').length) {
            return; 
        }

        var $radio = $(this).find('input[name="address"]');
        if (!$radio.prop('checked')) {
            $radio.prop('checked', true);
        }
    });

    // Initial check (useful if user navigates back and the state is preserved)
    $('.payment-radio:checked').trigger('change');
});
</script>
{% endblock %}